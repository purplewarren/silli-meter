(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}})();const f=16e3;class y{previousFrame=null;frameCount=0;processFrame(e){const s=Math.sqrt(e.reduce((a,c)=>a+c*c,0)/e.length),t=this.fft(e),o=t.slice(0,t.length/2),n=this.spectralCentroid(o),r=this.spectralRolloff(o),l=this.spectralFlux(o),i=this.zeroCrossingRate(e);return this.previousFrame=o,this.frameCount++,{rms:s,centroid:n,rolloff:r,flux:l,zcr:i}}aggregateFeatures(e){if(e.length===0)return{level_dbfs:-60,centroid_norm:0,rolloff_norm:0,flux_norm:0,vad_fraction:0,stationarity:0};const s=e.map(d=>d.rms),t=s.reduce((d,h)=>d+h,0)/s.length,o=20*Math.log10(Math.max(t,1e-10)),n=e.map(d=>d.centroid),r=Math.min(n.reduce((d,h)=>d+h,0)/n.length/(f/2),1),l=e.map(d=>d.rolloff),i=Math.min(l.reduce((d,h)=>d+h,0)/l.length/(f/2),1),a=e.map(d=>d.flux),c=Math.min(a.reduce((d,h)=>d+h,0)/a.length,1),p=.01,m=e.filter(d=>d.rms>p).length/e.length,w=Math.max(0,1-c);return{level_dbfs:o,centroid_norm:r,rolloff_norm:i,flux_norm:c,vad_fraction:m,stationarity:w}}fft(e){const s=e.length,t=new Float32Array(s),o=new Float32Array(s);for(let r=0;r<s;r++)t[r]=e[r];this.fftRecursive(t,o,s);const n=new Float32Array(s);for(let r=0;r<s;r++)n[r]=Math.sqrt(t[r]*t[r]+o[r]*o[r]);return n}fftRecursive(e,s,t){if(t<=1)return;const o=new Float32Array(t/2),n=new Float32Array(t/2),r=new Float32Array(t/2),l=new Float32Array(t/2);for(let i=0;i<t/2;i++)o[i]=e[i*2],n[i]=s[i*2],r[i]=e[i*2+1],l[i]=s[i*2+1];this.fftRecursive(o,n,t/2),this.fftRecursive(r,l,t/2);for(let i=0;i<t/2;i++){const a=-2*Math.PI*i/t,c=Math.cos(a),p=Math.sin(a),g=c*r[i]-p*l[i],m=p*r[i]+c*l[i];e[i]=o[i]+g,s[i]=n[i]+m,e[i+t/2]=o[i]-g,s[i+t/2]=n[i]-m}}spectralCentroid(e){let s=0,t=0;for(let o=0;o<e.length;o++){const n=o*f/(e.length*2);s+=n*e[o],t+=e[o]}return t>0?s/t:0}spectralRolloff(e){let t=0,o=0;for(let n=0;n<e.length;n++)t+=e[n];for(let n=0;n<e.length;n++)if(o+=e[n],o>=.85*t)return n*f/(e.length*2);return f/2}spectralFlux(e){if(!this.previousFrame)return 0;let s=0;for(let t=0;t<e.length;t++){const o=e[t]-this.previousFrame[t];s+=o*o}return Math.sqrt(s)}zeroCrossingRate(e){let s=0;for(let t=1;t<e.length;t++)e[t]>=0!=e[t-1]>=0&&s++;return s/e.length}}class v{weights;tips;constructor(){this.weights={w1_vad:35,w2_flux:20,w3_centroid:35,w4_level:35,w5_steady_bonus:10},this.tips={quiet:["Quiet minute + 4-7-8 breathing; speak softer than a whisper.","Dim lights to warm (~1800K); hide bright screens.","Lullaby pacing ~60–70 BPM; mirror child, then fade."],speech:["Lower your voice gradually; use gentle whispers.","Create a calm environment; reduce background noise.","Use soothing tones; avoid sudden volume changes."],tv_music:["Turn down media volume; use subtitles if needed.","Switch to calming sounds; avoid stimulating content.","Create a quiet zone; minimize electronic distractions."],white_noise:["White noise is good for sleep; keep it consistent.","Use gentle, steady sounds; avoid sudden changes.","Maintain a peaceful environment; reduce interruptions."]}}async loadWeightsAndTips(){try{const e=await fetch("/scoring/weights.json");e.ok&&(this.weights=await e.json());const s=await fetch("/scoring/tips.json");s.ok&&(this.tips=await s.json())}catch(e){console.warn("Could not load weights/tips, using defaults:",e)}}calculateScore(e){const s=Math.max(0,Math.min(1,(e.level_dbfs+60)/60));let t=100;t-=this.weights.w1_vad*e.vad_fraction,t-=this.weights.w2_flux*e.flux_norm,t-=this.weights.w3_centroid*e.centroid_norm,t-=this.weights.w4_level*s;const o=(1-e.flux_norm)*(e.level_dbfs>=-40&&e.level_dbfs<=-25?1:0);t+=this.weights.w5_steady_bonus*o,e.flux_norm<.12&&e.level_dbfs>=-40&&e.level_dbfs<=-25&&e.centroid_norm<.45&&(t+=6),t=Math.max(0,Math.min(100,t));const r=this.determineBadges(e),l=this.selectTips(t);return{score:Math.round(t),badges:r,tips:l}}determineBadges(e){const s=[];return e.vad_fraction>.3&&s.push("Speech present"),e.stationarity>.7&&s.push("Steady"),e.flux_norm>.5&&s.push("Fluctuating"),s}selectTips(e){let s;return e>=70?s="quiet":e>=50?s="speech":e>=30?s="tv_music":s="white_noise",this.tips[s]||this.tips.speech}}class b{audioContext=null;source=null;processor=null;stream=null;onFrameCallback=null;async initialize(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),this.audioContext=new AudioContext({sampleRate:16e3,latencyHint:"interactive"}),this.source=this.audioContext.createMediaStreamSource(this.stream),await this.audioContext.audioWorklet.addModule("/silli-meter/audio-worklet-processor.js"),this.processor=new AudioWorkletNode(this.audioContext,"audio-processor",{numberOfInputs:1,numberOfOutputs:1,processorOptions:{frameSize:1024}}),this.processor.port.onmessage=e=>{e.data.type==="frame"&&this.onFrameCallback&&this.onFrameCallback(e.data.audioData)},this.source.connect(this.processor)}catch(e){throw console.error("Failed to initialize audio:",e),e}}start(e){this.onFrameCallback=e,this.audioContext?.state==="suspended"&&this.audioContext.resume()}stop(){this.onFrameCallback=null,this.processor&&(this.processor.disconnect(),this.processor=null),this.source&&(this.source.disconnect(),this.source=null),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}class S{exportSession(e){const s=Date.now()-e.startTime,t=Math.floor(s/1e3),o=this.calculateFeaturesSummary(e.sessionData),n=this.calculateScores(e.sessionData),r={ts_start:new Date(e.startTime).toISOString(),duration_s:t,mode:e.config.mode,family_id:e.config.family,session_id:e.config.session,scales:{short_sec:10,mid_sec:60,long_sec:600},features_summary:o,score:n,badges:e.currentBadges,events:this.generateEvents(e.sessionData),pii:!1,version:"pwa_0.1"};return JSON.stringify(r,null,2)}calculateFeaturesSummary(e){if(e.length===0)return{level_dbfs_p50:-60,level_dbfs_p90:-60,centroid_norm_mean:0,flux_norm_mean:0,vad_fraction:0,stationarity:0};const s=e.map(a=>a.features.level_dbfs||-60),t=e.map(a=>a.features.centroid_norm||0),o=e.map(a=>a.features.flux_norm||0),n=e.map(a=>a.features.vad_fraction||0),r=e.map(a=>a.features.stationarity||0);s.sort((a,c)=>a-c);const l=Math.floor(s.length*.5),i=Math.floor(s.length*.9);return{level_dbfs_p50:s[l]||-60,level_dbfs_p90:s[i]||-60,centroid_norm_mean:t.reduce((a,c)=>a+c,0)/t.length,flux_norm_mean:o.reduce((a,c)=>a+c,0)/o.length,vad_fraction:n.reduce((a,c)=>a+c,0)/n.length,stationarity:r.reduce((a,c)=>a+c,0)/r.length}}calculateScores(e){if(e.length===0)return{short:0,mid:0,long:0,trend:"stable"};const s=this.calculateWindowScores(e,10),t=this.calculateWindowScores(e,60),o=this.calculateWindowScores(e,600);return{short:Math.round(s.average),mid:Math.round(t.average),long:Math.round(o.average),trend:this.calculateTrend({short:s,mid:t,long:o})}}calculateWindowScores(e,s){const t=s*1e3,o=Date.now(),n=e.filter(i=>o-i.timestamp<=t);if(n.length===0)return{average:0,trend:"stable"};const r=n.map(i=>{let a=100;return a-=i.features.vad_fraction*35,a-=i.features.flux_norm*20,a-=i.features.centroid_norm*35,a-=Math.max(0,Math.min(1,(i.features.level_dbfs+60)/60))*35,Math.max(0,Math.min(100,a))});return{average:r.reduce((i,a)=>i+a,0)/r.length,scores:r}}calculateTrend(e){return e.short>e.mid&&e.mid>e.long?"improving":e.short<e.mid&&e.mid<e.long?"declining":"stable"}generateEvents(e){const s=[];return e.length>0&&s.push({t:Math.floor(e[0].timestamp/1e3),type:"suggestion",id:"session_start"}),s}}class _{async generateCard(e){const s=document.createElement("canvas"),t=s.getContext("2d");s.width=800,s.height=600,t.fillStyle="#1a1a1a",t.fillRect(0,0,s.width,s.height),t.fillStyle="#ffffff",t.font="bold 32px Arial",t.textAlign="center",t.fillText("Silli Parent Night Helper",s.width/2,60),this.drawScoreCircle(t,e.score,s.width/2,200),t.fillStyle="#6366f1",t.font="bold 48px Arial",t.fillText(`${e.score}/100`,s.width/2,220),t.fillStyle="#ffffff",t.font="16px Arial",t.textAlign="center",t.fillText("Detected Features:",s.width/2,280),e.badges.forEach((r,l)=>{t.fillStyle="#6366f1",t.fillRect(300+l*120,300,100,30),t.fillStyle="#ffffff",t.font="12px Arial",t.fillText(r,350+l*120,320)});const o=Math.floor(e.duration/6e4),n=Math.floor(e.duration%6e4/1e3);return t.fillStyle="#888888",t.font="14px Arial",t.fillText(`Duration: ${o}:${n.toString().padStart(2,"0")}`,s.width/2,400),t.fillStyle="#666666",t.font="12px Arial",t.fillText("Privacy: Local analysis only",s.width/2,450),new Promise(r=>{s.toBlob(l=>{r(l)},"image/png")})}drawScoreCircle(e,s,t,o){const r=s/100;e.strokeStyle="#333333",e.lineWidth=8,e.beginPath(),e.arc(t,o,80,0,2*Math.PI),e.stroke(),e.strokeStyle="#6366f1",e.lineWidth=8,e.lineCap="round",e.beginPath(),e.arc(t,o,80,-Math.PI/2,-Math.PI/2+2*Math.PI*r),e.stroke()}}const x="https://silli-auto-ingest-relay.silli-tg-bot.workers.dev/ingest";class k{config;audioProcessor=null;featureExtractor;scorer;sessionExporter;shareCard;isRunning=!1;startTime=0;sessionData=[];currentScore=0;currentBadges=[];currentTips=[];lastTipTime=0;constructor(){this.config=this.parseUrlParams(),console.log("Token after parsing:",this.config.token?"FOUND":"NOT_FOUND"),this.stripTokenFromUrl(),console.log("Token after stripping:",this.config.token?"FOUND":"NOT_FOUND"),this.featureExtractor=new y,this.scorer=new v,this.sessionExporter=new S,this.shareCard=new _,this.initializeUI(),this.loadWeightsAndTips()}parseUrlParams(){const e=new URLSearchParams(window.location.search);return{mode:e.get("mode")||"helper",family:e.get("family")||"fam_unknown",session:e.get("session")||`fam_unknown_${Date.now()}`,token:e.get("tok")||null}}async loadWeightsAndTips(){await this.scorer.loadWeightsAndTips()}initializeUI(){const e=document.getElementById("app");e.innerHTML=`
      <div class="container">
        <header>
          <h1>Silli Parent Night Helper</h1>
          <p class="mode">${this.config.mode==="helper"?"Helper Mode":"Low-Power Mode"}</p>
        </header>
        
        <main>
          <div class="score-display">
            <div class="score-ring">
              <svg viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="50" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                <circle id="score-circle" cx="60" cy="60" r="50" fill="none" stroke="#6366f1" stroke-width="8" 
                        stroke-dasharray="314" stroke-dashoffset="314" transform="rotate(-90 60 60)"/>
              </svg>
              <div class="score-text">
                <span id="score-value">0</span>
                <span class="score-label">/100</span>
              </div>
            </div>
          </div>
          
          <div class="badges">
            <div id="badges-container"></div>
          </div>
          
          <div class="tips">
            <h3>Tips</h3>
            <div id="tips-container"></div>
          </div>
          
          <div class="controls">
            <button id="start-btn" class="btn primary">Start Session</button>
            <button id="stop-btn" class="btn secondary" disabled>Stop Session</button>
            <button id="export-btn" class="btn secondary" disabled>Process Results</button>
          </div>
          
          <div class="session-info">
            <p>Session: ${this.config.session}</p>
            <p>Duration: <span id="duration">00:00</span></p>
          </div>
        </main>
        
        <footer>
          <p class="privacy">Privacy: All analysis runs locally. No audio is uploaded.</p>
        </footer>
      </div>
    `,this.bindEvents()}bindEvents(){const e=document.getElementById("start-btn"),s=document.getElementById("stop-btn"),t=document.getElementById("export-btn");e.addEventListener("click",()=>this.startSession()),s.addEventListener("click",()=>this.stopSession()),t.addEventListener("click",()=>this.exportResults())}async startSession(){try{this.audioProcessor=new b,await this.audioProcessor.initialize(),this.isRunning=!0,this.startTime=Date.now(),this.sessionData=[],this.audioProcessor.start(e=>{this.processAudioFrame(e)}),document.getElementById("start-btn").disabled=!0,document.getElementById("stop-btn").disabled=!1,this.updateTimer(),this.config.mode==="helper"&&this.requestWakeLock()}catch(e){console.error("Failed to start session:",e),e instanceof Error?e.name==="NotAllowedError"?alert("Microphone access denied. Please allow microphone permissions and try again."):e.name==="NotFoundError"?alert("No microphone found. Please connect a microphone and try again."):alert(`Audio initialization failed: ${e.message}. Please check microphone permissions and try again.`):alert("Could not start audio analysis. Please check microphone permissions and try again.")}}stopSession(){this.isRunning=!1,this.audioProcessor?.stop(),document.getElementById("start-btn").disabled=!1,document.getElementById("stop-btn").disabled=!0,document.getElementById("export-btn").disabled=!1}processAudioFrame(e){if(!this.isRunning)return;const s=this.featureExtractor.processFrame(e);this.sessionData.push({timestamp:Date.now()-this.startTime,features:s}),this.sessionData.length%160===0&&this.aggregateAndScore()}aggregateAndScore(){const s=this.sessionData.slice(-160).map(r=>r.features),t=this.featureExtractor.aggregateFeatures(s),o=this.scorer.calculateScore(t);this.currentScore=o.score,this.currentBadges=o.badges,this.currentTips=o.tips,this.updateScoreDisplay(),this.updateBadges();const n=Date.now();n-this.lastTipTime>6e4&&(this.showTip(),this.lastTipTime=n)}updateScoreDisplay(){const e=document.getElementById("score-value"),s=document.getElementById("score-circle");e.textContent=this.currentScore.toString();const t=2*Math.PI*50,o=this.currentScore/100,n=t-o*t;s.style.strokeDashoffset=n.toString()}updateBadges(){const e=document.getElementById("badges-container");e.innerHTML=this.currentBadges.map(s=>`<span class="badge">${s}</span>`).join("")}showTip(){const e=document.getElementById("tips-container"),s=this.currentTips[Math.floor(Math.random()*this.currentTips.length)];e.innerHTML=`<p class="tip">${s}</p>`}updateTimer(){if(!this.isRunning)return;const e=Date.now()-this.startTime,s=Math.floor(e/6e4),t=Math.floor(e%6e4/1e3);document.getElementById("duration").textContent=`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`,requestAnimationFrame(()=>this.updateTimer())}async requestWakeLock(){try{"wakeLock"in navigator&&(await navigator.wakeLock.request("screen"),console.log("Wake lock acquired"))}catch(e){console.warn("Could not acquire wake lock:",e)}}async exportResults(){const e=this.sessionExporter.exportSession({config:this.config,sessionData:this.sessionData,startTime:this.startTime,currentScore:this.currentScore,currentBadges:this.currentBadges}),s=await this.shareCard.generateCard({score:this.currentScore,badges:this.currentBadges,duration:Date.now()-this.startTime});await this.sendToRelay(e,s)}async sendToRelay(e,s){const t=document.getElementById("export-btn");try{t.textContent="Sending to Silli...",t.disabled=!0;const o=this.config.token;if(!o){console.warn("No session token found in URL params (tok=...)"),this.fallbackDownload(e,s,"Missing session token. Files downloaded instead.");return}const n=await fetch(x,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:e});if(!n.ok){const l=await n.text().catch(()=>"");throw new Error(`Relay error: ${n.status} ${l}`)}const r=document.createElement("div");r.innerHTML=`
        <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; padding: 16px; margin: 16px 0;">
          <h4>✅ Session Sent to Silli</h4>
          <p>Your session report was delivered securely.</p>
          <p><strong>Session ID:</strong> ${this.config.session}</p>
          <p>You’ll see a confirmation in your Telegram chat.</p>
        </div>
      `,document.querySelector(".container")?.appendChild(r),t.textContent="Sent ✅"}catch(o){console.error("Failed to send to relay:",o),this.fallbackDownload(e,s,"Auto-send failed (offline or network issue). Files downloaded instead."),t.textContent="Downloaded"}finally{setTimeout(()=>{t.textContent="Process Results",t.disabled=!1},3e3)}}downloadFile(e,s,t){const o=new Blob([e],{type:t}),n=URL.createObjectURL(o),r=document.createElement("a");r.href=n,r.download=s,r.click(),URL.revokeObjectURL(n)}fallbackDownload(e,s,t){this.downloadFile(e,"session.json","application/json"),this.downloadFile(s,"session-card.png","image/png");const o=document.createElement("div");o.innerHTML=`
      <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 16px 0;">
        <h4>⚠️ Auto-send Unavailable</h4>
        <p>${t}</p>
        <p><strong>Session ID:</strong> ${this.config.session}</p>
        <p>You can upload the session.json to the bot with /ingest as a fallback.</p>
      </div>
    `,document.querySelector(".container")?.appendChild(o)}stripTokenFromUrl(){const e=new URL(window.location.href);e.searchParams.has("tok")&&(e.searchParams.delete("tok"),history.replaceState(null,"",e.toString()))}}new k;
